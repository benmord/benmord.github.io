<HTML>
<HEAD>
<META name="viewport" content="width=980, user-scalable=no" />
</HEAD>

<BODY bgcolor="#F8F8F8">


<SVG style="background-color:#CCCCCC;" width="964" height="1804" version="1.1"
xmlns="http://www.w3.org/2000/svg" id="svgCanvas" >
</SVG>


<SCRIPT>
	var svgNS = "http://www.w3.org/2000/svg";
	var cont = document.getElementById("svgCanvas");
	
	function drawText(text, weight, fill, anchor, id, x, y, size, invoke="", rotate=false, cl='', makerect=true, rectcolor='#ccccaa', rectw=180, recth=110) {
		var nodeG = document.createElementNS(svgNS, 'g');
		nodeG.setAttributeNS(null, "onmousedown", invoke);
		nodeG.setAttributeNS(null, "class", cl);
		nodeG.setAttributeNS(null, "id", id);
		var nodeTxt = document.createElementNS(svgNS, 'text');
		nodeTxt.setAttributeNS(null, "font-weight", weight);
		nodeTxt.setAttributeNS(null, "fill", fill);
		nodeTxt.setAttributeNS(null, "font-size", size);	
		nodeTxt.setAttributeNS(null, "text-anchor", anchor);
		if (rotate) {
			nodeTxt.setAttributeNS(null, "writing-mode", "tb");
//			nodeTxt.setAttributeNS(null, "glyph-orientation-vertical", "0");
		}
//		nodeTxt.setAttributeNS(null, "id", id);
		nodeTxt.setAttributeNS(null, "class", cl);
//		nodeTxt.setAttributeNS(null, "onclick", invoke);		
		var txt = document.createTextNode(text);
		nodeTxt.appendChild(txt);
		nodeTxt.setAttributeNS(null, "x", x);
		nodeTxt.setAttributeNS(null, "y", y);			
		cont.appendChild(nodeG);
		if (makerect) {
			var nodeRect = document.createElementNS(svgNS, 'rect');
			nodeRect.setAttributeNS(null, "width", rectw);
			nodeRect.setAttributeNS(null, "height", recth);
			nodeRect.setAttributeNS(null, "x", x-(rectw/2));
			nodeRect.setAttributeNS(null, "y", y-recth + 20);
			nodeRect.setAttributeNS(null, "style", "fill:"+ rectcolor +";opacity:1");
			nodeG.appendChild(nodeRect);
		}
		nodeG.appendChild(nodeTxt);		
	}
	
		
	function removeElement(id) {
//		alert('removing element ' + id)
		var e = document.getElementById(id);
		e.parentNode.removeChild(e);
	}
	
	
	function getWidth() {
		if (cont.width.animVal.unitType != 2) {
//			alert('WARNING - unit type is ' + cont.width.animVal.unitType)
		}
		return cont.width.animVal.value;
	}	
	
	function getHeight() {
		if (cont.height.animVal.unitType != 2) {
//			alert('WARNING - unit type is ' + cont.height.animVal.unitType)
		}
		return cont.height.animVal.value;
	}
	
//	animate('question');

	var cw = 192;
	var ch = 120;

	stack = [];
	entry = '';
	
	

	function removeClass(cl) {
		var oldItems = document.getElementsByClassName(cl);
		while (oldItems.length != 0) {
			for (var i=0; i<oldItems.length; i++) {
				oldItems[i].remove();	
			}
			oldItems = document.getElementsByClassName(cl);
		}
	}
		
	
	function disp(num) {
		if ((Math.abs(parseFloat(num)) / 10000 > 1 || Math.abs(parseFloat(num)) * 10000 < 1) && parseFloat(num) != 0) {
			return parseFloat(num).toExponential(8);
		} else if (num.toString().length > 14) {
			return num.toString().substring(0, 11) + '...';
		}				
		return num.toString();
	}	
	
	function toclip(data) {
		
	}

	function drawStack() {
		removeClass('stackitem');
		for (var i=0; i<stack.length; i++) {
			h = i*ch + 0.6*getHeight() - (stack.length)*ch;
//			h = 0.6*getHeight() - i*ch
			drawText(disp(stack[i]), 'bold', 'black', 'end', 'score', getWidth() - 0.5*cw, h, 90, 'toclip("' + stack[i].toString() + '")', false, 'stackitem', false);
		}
	
	}
	
	function drawEntry() {
		var oldItems = document.getElementsByClassName('entry');
		for (var i=0; i<oldItems.length; i++) {
			oldItems[i].remove();
		}	
		drawText(entry, 'bold', 'black', 'start', 'score', 0.1*cw, 0.6*getHeight(), 90, '', false, 'entry', false);
	}
	
	var page=0;	
	
	
	function calculate() {
		switch(entry) {
			case '⏎':
				break;
			case '+':
				stack.push((parseFloat(stack.pop()) + parseFloat(stack.pop())).toString());
				break;
			case '-':
				b = parseFloat(stack.pop());
				a = parseFloat(stack.pop());
				stack.push((a - b).toString());
				break;
			case '*':
				stack.push((parseFloat(stack.pop()) * parseFloat(stack.pop())).toString());
				break;
			case '/':
				b = parseFloat(stack.pop());
				a = parseFloat(stack.pop());
				stack.push((a / b).toString());
				break;
			case 'C':
				stack.pop();
				break;
			case 'SWAP':
				b = parseFloat(stack.pop());
				a = parseFloat(stack.pop());
				stack.push(b.toString());
				stack.push(a.toString());
				break;
			case 'LOG':
				a = parseFloat(stack.pop());
				stack.push(Math.log10(a).toString());
				break;
			case 'LN':
				a = parseFloat(stack.pop());
				stack.push(Math.log(a).toString());
				break;
			case 'EXP':
				b = parseFloat(stack.pop());
				a = parseFloat(stack.pop());
				stack.push(a ** b).toString();
				break;
			case 'PI':
				stack.push('3.1415926535');
				break;
			case '(-)':
				entry = '';
				runscript('0 E SWAP -');
				break;
			case 'HIST':
				entry = '';
				navigator.clipboard.writeText(cmdhistory.join(' '));
				break;
			case 'RUN':
				entry = '';
				navigator.clipboard.readText().then(clipText => runscript(clipText));
				break;
			case 'UNDO':
				entry = '';
				cmdhistory.pop();
				histc = Array.from(cmdhistory);
				cmdhistory=[];
				stack=[];
				runscript(histc.join(' '), true);
				break;
			case 'SIN':
				a = parseFloat(stack.pop());
				stack.push(Math.sin(a).toString());
				break;
			case 'COS':
				a = parseFloat(stack.pop());
				stack.push(Math.cos(a).toString());
				break;
			case 'TAN':
				a = parseFloat(stack.pop());
				stack.push(Math.tan(a).toString());
				break;
			case 'PREV':
				page = (2 + page - 1) % 2;
				drawMenu(page);
				break;
			case 'NEXT':
				page = (page + 1) % 2;
				drawMenu(page);
				break;
		}
		entry='';
		drawEntry();
		drawStack();
		drawHistory();
	}
	
	var cmdhistory=[];
	
	function input(cmd) {
		cmdhistory.push(cmd);
		act(cmd);
	}
	
	function act(cmd) {
//		alert(cmd);
		if ('0123456789.'.includes(cmd)) {
			entry += cmd
			drawEntry();
		} else {
			if (entry != '') {
				stack.push(entry);
				entry = ''
			} else if (cmd == '⏎' && stack.length>0) {
				a = stack.pop();
				stack.push(a);
				stack.push(a);
			}
			entry = cmd;
			calculate();
		}
	}
	
	function runscript(script, record=false) {
		cmds = script.split(' ');
		for (var i=0;i<cmds.length;i++) {
			if (record) {
				input(cmds[i]);
			} else {
				act(cmds[i]);
			}
		}
	}
	
	function drawEnter(cw, ch) {
//		drawText('ENTER', 'bold', 'green', 'start', 'score', 0.5*cw, getHeight() - 95 - ch, 60, 'input("⏎")', true, 'button', true, 'orange', 10, 10);	

		var x = 0.5*cw;
		var y = getHeight() - .66*ch;

		var nodeG = document.createElementNS(svgNS, 'g');
		nodeG.setAttributeNS(null, "onmousedown", 'input("⏎")');
		nodeG.setAttributeNS(null, "class", 'button');
		var nodeTxt = document.createElementNS(svgNS, 'text');
		nodeTxt.setAttributeNS(null, "font-weight", 'bold');
		nodeTxt.setAttributeNS(null, "fill", 'green');
		nodeTxt.setAttributeNS(null, "font-size", '60');	
		nodeTxt.setAttributeNS(null, "text-anchor", 'middle');
//		nodeTxt.setAttributeNS(null, "writing-mode", "tb");
		nodeTxt.setAttributeNS(null, "id", 'EnterButton');
		nodeTxt.setAttributeNS(null, "class", 'button');
//		nodeTxt.setAttributeNS(null, "onclick", invoke);		
		var txt = document.createTextNode('⏎');
		nodeTxt.appendChild(txt);
		nodeTxt.setAttributeNS(null, "x", x);
		nodeTxt.setAttributeNS(null, "y", y);			
		cont.appendChild(nodeG);
		if (true) {
			var nodeRect = document.createElementNS(svgNS, 'rect');
			nodeRect.setAttributeNS(null, "width", 180);
			nodeRect.setAttributeNS(null, "height", 230);
			nodeRect.setAttributeNS(null, "x", x-90);
			nodeRect.setAttributeNS(null, "y", y-ch - .33*ch + 20);
			nodeRect.setAttributeNS(null, "style", "fill:#ccccaa;opacity:1");
			nodeG.appendChild(nodeRect);
		}
		nodeG.appendChild(nodeTxt);		
	}	


	function drawButton(label, color, xindex, yindex, pt, call) {
		x = (xindex + 0.5)*cw;
		y = getHeight() - 10 - yindex*ch;
		drawText(label, 'bold', color, 'middle', 'button_' + xindex.toString() + '_' + yindex.toString(), x, y, pt, call);
	}


	function drawKeyboard() {
	
//		drawText('ENT', 'bold', 'black', 'center', 30, getHeight() - 10, 70);	
		drawButton('0', 'black', 1, 0, 100, 'input("0")');
		drawButton('.', 'black', 2, 0, 100, 'input(".")');
		drawButton('(-)', 'black', 3, 0, 100, 'input("(-)")');
		drawButton('+', 'blue', 4, 0, 100, 'input("+")');

//		drawText('ENTER', 'bold', 'green', 'start', 0.5*cw, getHeight() - 95 - ch, 60, 'input("⏎")', true, 'button', true, 'orange', 10, 10);
		drawEnter(cw, ch);			
		drawButton('1', 'black', 1, 1, 100, 'input("1")');
		drawButton('2', 'black', 2, 1, 100, 'input("2")');
		drawButton('3', 'black', 3, 1, 100, 'input("3")');
		drawButton('-', 'blue', 4, 1, 100, 'input("-")');
		
		drawButton('C', 'blue', 0, 2, 100, 'input("C")');
		drawButton('4', 'black', 1, 2, 100, 'input("4")');
		drawButton('5', 'black', 2, 2, 100, 'input("5")');
		drawButton('6', 'black', 3, 2, 100, 'input("6")');
		drawButton('x', 'blue', 4, 2, 100, 'input("*")');
				
		drawButton('↶', 'blue', 0, 3, 100, 'act("UNDO")');
		drawButton('7', 'black', 1, 3, 100, 'input("7")');
		drawButton('8', 'black', 2, 3, 100, 'input("8")');
		drawButton('9', 'black', 3, 3, 100, 'input("9")');
		drawButton('/', 'blue', 4, 3, 100, 'input("/")');
				
		drawButton('SWAP', 'red', 0, 4, 65, 'input("SWAP")');
		drawButton('LOG', 'red', 1, 4, 65, 'input("LOG")');
		drawButton('LN', 'red', 2, 4, 65, 'input("LN")');
		drawButton('EXP', 'red', 3, 4, 65, 'input("EXP")');
		drawButton('Pi', 'red', 4, 4, 65, 'input("PI")');
				
		drawButton('HIST', 'red', 0, 5, 65, 'act("HIST")');
		drawButton('RUN', 'red', 1, 5, 65, 'act("RUN")');
		drawButton('SIN', 'red', 2, 5, 65, 'input("SIN")');
		drawButton('COS', 'red', 3, 5, 65, 'input("COS")');
		drawButton('TAN', 'red', 4, 5, 65, 'input("TAN")');
				

	}
	
	function eraseMenu() {
		for (xindex=0;xindex<5;xindex++) {
			for (yindex=4;yindex<6;yindex++) {
				removeElement("button_" + xindex.toString() + '_' + yindex.toString());
			}
		}
	}
	
	function drawMenu(pg) {
		eraseMenu();
		switch(pg) {
			case 0:
				drawButton('SWAP', 'red', 0, 4, 65, 'input("SWAP")');
				drawButton('LOG', 'red', 1, 4, 65, 'input("LOG")');
				drawButton('LN', 'red', 2, 4, 65, 'input("LN")');
				drawButton('EXP', 'red', 3, 4, 65, 'input("EXP")');
				drawButton('Pi', 'red', 4, 4, 65, 'input("PI")');
						
				drawButton('←', 'purple', 0, 5, 65, 'act("PREV")');
				drawButton('SIN', 'red', 1, 5, 65, 'act("SIN")');
				drawButton('COS', 'red', 2, 5, 65, 'input("COS")');
				drawButton('TAN', 'red', 3, 5, 65, 'input("TAN")');
				drawButton('→', 'purple', 4, 5, 65, 'act("NEXT")');			
				break
			case 1:
				drawButton('SWAP', 'red', 0, 4, 65, 'input("SWAP")');
				drawButton('HIST', 'red', 1, 4, 65, 'input("HIST")')
				drawButton('RUN', 'red', 2, 4, 65, 'input("RUN")');
				drawButton('EXP', 'red', 3, 4, 65, 'input("EXP")');
				drawButton('Pi', 'red', 4, 4, 65, 'input("PI")');
						
				drawButton('←', 'purple', 0, 5, 65, 'act("PREV")');
				drawButton('ASIN', 'red', 1, 5, 65, 'act("ASIN")');
				drawButton('ACOS', 'red', 2, 5, 65, 'input("ACOS")');
				drawButton('ATAN', 'red', 3, 5, 65, 'input("ATAN")');
				drawButton('→', 'purple', 4, 5, 65, 'act("NEXT")');			
				break
		}
	}
	
	function drawHistory() {
		x = getWidth() - 0.5*cw;
		y = ch;
		drawText(cmdhistory.join(' '), 'bold', 'brown', 'end', 'score', x, y, 50, '', false, 'stackitem', false);	
	}
	
	drawKeyboard();
	drawStack();
	drawEntry();
	drawHistory();

//	eraseMenu();
	drawMenu(0);

	function dostuff() {
		alert('was clicked!!');
		alert(getWidth());
		alert(getHeight());
		//964 x 1804.3636... Chrome on a Pixel 4a
	}


</SCRIPT>





</BODY>


</HTML>
